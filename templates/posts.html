{% extends "base.html" %}

{% block title %}r/{{ subreddit }} - Reddit Reader{% endblock %}

{% block content %}
<!-- Mini navigation sidebar -->
<div class="mini-nav" id="mini-nav">
    <div class="mini-nav-title">Posts</div>
    <div class="mini-nav-items" id="mini-nav-items">
        {% for post in posts %}
        <a href="#post-{{ loop.index }}" class="mini-nav-item" data-post-index="{{ loop.index }}" title="{{ post.title }}">
            {% if post.thumbnail and post.thumbnail.startswith('http') %}
            <img src="{{ post.thumbnail }}" alt="" class="mini-nav-thumb">
            {% elif post.image_url %}
            <img src="{{ post.image_url }}" alt="" class="mini-nav-thumb">
            {% elif post.is_self %}
            <div class="mini-nav-placeholder">ğŸ“</div>
            {% else %}
            <div class="mini-nav-placeholder">ğŸ”—</div>
            {% endif %}
        </a>
        {% endfor %}
    </div>
</div>

<div class="main-content">
<div class="subreddit-nav">
    {% if current_user.is_authenticated and pinned_subs %}
        {% for sub in pinned_subs[:5] %}
        <a href="{{ url_for('subreddit', name=sub) }}" class="subreddit-link {% if sub == subreddit %}active{% endif %}">r/{{ sub }}</a>
        {% endfor %}
        {% if subreddit not in pinned_subs[:5] %}
        <span class="subreddit-link active">r/{{ subreddit }}</span>
        {% endif %}
    {% else %}
        <a href="{{ url_for('subreddit', name='all') }}" class="subreddit-link {% if subreddit == 'all' %}active{% endif %}">r/all</a>
        <a href="{{ url_for('subreddit', name='popular') }}" class="subreddit-link {% if subreddit == 'popular' %}active{% endif %}">r/popular</a>
        {% if subreddit not in ['all', 'popular'] %}
        <span class="subreddit-link active">r/{{ subreddit }}</span>
        {% endif %}
    {% endif %}
</div>

<div class="controls">
    <span class="text-secondary">Sort by:</span>
    <a href="{{ url_for('subreddit', name=subreddit, sort='hot') }}" 
       class="sort-link {% if sort == 'hot' %}active{% endif %}">ğŸ”¥ Hot</a>
    <a href="{{ url_for('subreddit', name=subreddit, sort='new') }}" 
       class="sort-link {% if sort == 'new' %}active{% endif %}">ğŸ†• New</a>
    <a href="{{ url_for('subreddit', name=subreddit, sort='top', t=time_filter or 'day') }}" 
       class="sort-link {% if sort == 'top' %}active{% endif %}">â­ Top</a>
    <a href="{{ url_for('subreddit', name=subreddit, sort='rising') }}" 
       class="sort-link {% if sort == 'rising' %}active{% endif %}">ğŸ“ˆ Rising</a>
    
    {% if sort == 'top' %}
    <span class="time-filter-divider">|</span>
    <select id="time-filter" class="time-filter-select" onchange="window.location.href=this.value">
        <option value="{{ url_for('subreddit', name=subreddit, sort='top', t='hour') }}" {% if time_filter == 'hour' %}selected{% endif %}>Past Hour</option>
        <option value="{{ url_for('subreddit', name=subreddit, sort='top', t='day') }}" {% if time_filter == 'day' %}selected{% endif %}>Today</option>
        <option value="{{ url_for('subreddit', name=subreddit, sort='top', t='week') }}" {% if time_filter == 'week' %}selected{% endif %}>This Week</option>
        <option value="{{ url_for('subreddit', name=subreddit, sort='top', t='month') }}" {% if time_filter == 'month' %}selected{% endif %}>This Month</option>
        <option value="{{ url_for('subreddit', name=subreddit, sort='top', t='year') }}" {% if time_filter == 'year' %}selected{% endif %}>This Year</option>
        <option value="{{ url_for('subreddit', name=subreddit, sort='top', t='all') }}" {% if time_filter == 'all' %}selected{% endif %}>All Time</option>
    </select>
    {% endif %}
</div>

<div id="posts-container" 
     data-subreddit="{{ subreddit }}" 
     data-sort="{{ sort }}" 
     data-time-filter="{{ time_filter or 'day' }}"
     data-after="{{ after or '' }}"
     data-comments-limit="{{ comments_limit }}">
{% if posts %}
    {% for post in posts %}
    <article class="post" id="post-{{ loop.index }}" data-post-index="{{ loop.index }}" data-thumbnail="{{ post.thumbnail or post.image_url or '' }}">
        <h2 class="post-title">
            <a href="{{ url_for('comments', subreddit=post.subreddit, post_id=post.id) }}">
                {{ post.title }}
            </a>
        </h2>
        
        <div class="post-meta">
            <span class="post-meta-item">ğŸ‘¤ u/{{ post.author }}</span>
            <span class="post-meta-item">ğŸ“ r/{{ post.subreddit }}</span>
            <span class="post-meta-item">â¬†ï¸ {{ "{:,}".format(post.score) }}</span>
            <span class="post-meta-item">ğŸ’¬ {{ "{:,}".format(post.num_comments) }}</span>
            <span class="post-meta-item">ğŸ• {{ reader.format_timestamp(post.created_utc) }}</span>
            <span class="post-meta-actions">
                {% if not post.is_self %}
                <a href="{{ post.url }}" target="_blank" class="meta-action-btn" title="Open link">ğŸ”—</a>
                {% endif %}
                <a href="{{ post.permalink }}" target="_blank" class="meta-action-btn" title="View on Reddit">ğŸ“¤</a>
                {% if current_user.is_authenticated and post.subreddit != subreddit %}
                <form method="post" action="{{ url_for('ban_subreddit', subreddit=post.subreddit) }}" class="inline-form" onsubmit="return confirm('Ban r/{{ post.subreddit }}? Posts from this subreddit will be hidden.')">
                    <button type="submit" class="meta-action-btn ban-btn" title="Ban r/{{ post.subreddit }}">ğŸš«</button>
                </form>
                {% endif %}
            </span>
        </div>
        
        {% if post.is_self and post.selftext %}
        <div class="post-selftext">
            {{ post.selftext[:300] }}{% if post.selftext|length > 300 %}...{% endif %}
        </div>
        {% endif %}

        {% if post.is_video and (post.hls_url or post.video_url) %}
        <div class="post-media video-container" data-hls-url="{{ post.hls_url }}" data-audio-url="{{ post.audio_url }}">
            <video class="post-video" src="{{ post.video_url }}" loop playsinline autoplay muted></video>
            {% if post.audio_url %}
            <audio class="video-audio" src="{{ post.audio_url }}" style="display:none;" loop muted></audio>
            {% endif %}
            <button class="media-download-btn" data-url="{{ post.video_url }}" data-type="video" title="Download" aria-label="Download">
                â¤“
            </button>
            <div class="video-controls">
                <button class="video-btn video-play-pause" aria-label="Play/Pause">â¸</button>
                <div class="video-timeline">
                    <div class="video-progress"></div>
                </div>
                <div class="video-volume-container">
                    <button class="video-btn video-mute" aria-label="Mute">ğŸ”‡</button>
                    <input type="range" class="video-volume-slider" min="0" max="100" value="0">
                </div>
                <div class="video-speed-container">
                    <select class="video-speed-select" aria-label="Playback speed">
                        <option value="0.25">0.25x</option>
                        <option value="0.5">0.5x</option>
                        <option value="0.75">0.75x</option>
                        <option value="1" selected>1x</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                        <option value="1.75">1.75x</option>
                        <option value="2">2x</option>
                    </select>
                </div>
                <button class="video-btn video-fullscreen" aria-label="Fullscreen">â›¶</button>
            </div>
        </div>
        {% elif post.gallery_urls and post.gallery_urls|length > 0 %}
        <div class="post-media gallery">
            <div class="gallery-scroll">
                {% for url in post.gallery_urls %}
                <div class="gallery-item">
                    <img class="gallery-image" src="{{ url }}" alt="Gallery image" loading="lazy">
                    <button class="media-download-btn" data-url="{{ url }}" data-type="image" title="Download" aria-label="Download">
                        â¤“
                    </button>
                </div>
                {% endfor %}
            </div>
            {% if post.gallery_urls|length > 1 %}
            <button class="gallery-nav gallery-nav-left" aria-label="Previous image">â€¹</button>
            <button class="gallery-nav gallery-nav-right" aria-label="Next image">â€º</button>
            {% endif %}
        </div>
        {% elif post.image_url %}
        <div class="post-media">
            <img class="post-image" src="{{ post.image_url }}" alt="Post image">
            <button class="media-download-btn" data-url="{{ post.image_url }}" data-type="image" title="Download" aria-label="Download">
                â¤“
            </button>
        </div>
        {% endif %}
        


        <div class="post-top-comments">
            <div class="post-top-comments-title">Top comments</div>
            <button class="btn comment-toggle"
                    data-subreddit="{{ post.subreddit }}"
                    data-post-id="{{ post.id }}"
                    data-limit="{{ comments_limit }}">
                Load comments
            </button>
            <div class="comment-list" data-show-author="false" hidden></div>
        </div>
    </article>
    {% endfor %}
</div>

<div id="loading-indicator" style="display: none; text-align: center; padding: 20px;">
    <span class="text-secondary">Loading more posts...</span>
</div>

<div id="no-more-posts" style="display: none; text-align: center; padding: 20px;">
    <span class="text-secondary">No more posts to load</span>
</div>
</div><!-- close main-content -->

{% else %}
    <div class="error-container">
        <div class="error-title">ğŸ˜•</div>
        <p class="error-message">No posts found for r/{{ subreddit }}</p>
        <a href="{{ url_for('index') }}" class="btn btn-primary">Go to r/all</a>
    </div>
</div>
</div>
{% endif %}

<script>
(function() {
    const container = document.getElementById('posts-container');
    if (!container) return;
    
    const subreddit = container.dataset.subreddit;
    const sort = container.dataset.sort;
    const timeFilter = container.dataset.timeFilter || 'day';
    const commentsLimit = container.dataset.commentsLimit;
    let after = container.dataset.after;
    let loading = false;
    let noMorePosts = false;
    let postCount = document.querySelectorAll('.post').length;
    
    const loadingIndicator = document.getElementById('loading-indicator');
    const noMoreIndicator = document.getElementById('no-more-posts');
    
    // Create post HTML from post data
    function createPostHTML(post, index) {
        const selftext = post.selftext ? post.selftext.substring(0, 300) + (post.selftext.length > 300 ? '...' : '') : '';
        const score = post.score.toLocaleString();
        const numComments = post.num_comments.toLocaleString();
        
        let mediaHTML = '';
        
        if (post.is_video && (post.hls_url || post.video_url)) {
            mediaHTML = `
                <div class="post-media video-container" data-hls-url="${post.hls_url || ''}" data-audio-url="${post.audio_url || ''}">
                    <video class="post-video" src="${post.video_url}" loop playsinline autoplay muted></video>
                    ${post.audio_url ? `<audio class="video-audio" src="${post.audio_url}" style="display:none;" loop muted></audio>` : ''}
                    <button class="media-download-btn" data-url="${post.video_url}" data-type="video" title="Download" aria-label="Download">â¤“</button>
                    <div class="video-controls">
                        <button class="video-btn video-play-pause" aria-label="Play/Pause">â¸</button>
                        <div class="video-timeline"><div class="video-progress"></div></div>
                        <div class="video-volume-container">
                            <button class="video-btn video-mute" aria-label="Mute">ğŸ”‡</button>
                            <input type="range" class="video-volume-slider" min="0" max="100" value="0">
                        </div>
                        <div class="video-speed-container">
                            <select class="video-speed-select" aria-label="Playback speed">
                                <option value="0.25">0.25x</option>
                                <option value="0.5">0.5x</option>
                                <option value="0.75">0.75x</option>
                                <option value="1" selected>1x</option>
                                <option value="1.25">1.25x</option>
                                <option value="1.5">1.5x</option>
                                <option value="1.75">1.75x</option>
                                <option value="2">2x</option>
                            </select>
                        </div>
                        <button class="video-btn video-fullscreen" aria-label="Fullscreen">â›¶</button>
                    </div>
                </div>`;
        } else if (post.gallery_urls && post.gallery_urls.length > 0) {
            const galleryItems = post.gallery_urls.map(url => `
                <div class="gallery-item">
                    <img class="gallery-image" src="${url}" alt="Gallery image" loading="lazy">
                    <button class="media-download-btn" data-url="${url}" data-type="image" title="Download" aria-label="Download">â¤“</button>
                </div>
            `).join('');
            mediaHTML = `
                <div class="post-media gallery">
                    <div class="gallery-scroll">${galleryItems}</div>
                    ${post.gallery_urls.length > 1 ? `
                        <button class="gallery-nav gallery-nav-left" aria-label="Previous image">â€¹</button>
                        <button class="gallery-nav gallery-nav-right" aria-label="Next image">â€º</button>
                    ` : ''}
                </div>`;
        } else if (post.image_url) {
            mediaHTML = `
                <div class="post-media">
                    <img class="post-image" src="${post.image_url}" alt="Post image">
                    <button class="media-download-btn" data-url="${post.image_url}" data-type="image" title="Download" aria-label="Download">â¤“</button>
                </div>`;
        }
        
        const thumbnail = post.thumbnail || post.image_url || '';
        
        return `
            <article class="post" id="post-${index}" data-post-index="${index}" data-thumbnail="${thumbnail}">
                <h2 class="post-title">
                    <a href="/r/${post.subreddit}/comments/${post.id}">${post.title}</a>
                </h2>
                <div class="post-meta">
                    <span class="post-meta-item">ğŸ‘¤ u/${post.author}</span>
                    <span class="post-meta-item">ğŸ“ r/${post.subreddit}</span>
                    <span class="post-meta-item">â¬†ï¸ ${score}</span>
                    <span class="post-meta-item">ğŸ’¬ ${numComments}</span>
                    <span class="post-meta-actions">
                        ${!post.is_self ? `<a href="${post.url}" target="_blank" class="meta-action-btn" title="Open link">ğŸ”—</a>` : ''}
                        <a href="${post.permalink}" target="_blank" class="meta-action-btn" title="View on Reddit">ğŸ“¤</a>
                    </span>
                </div>
                ${post.is_self && selftext ? `<div class="post-selftext">${selftext}</div>` : ''}
                ${mediaHTML}
                <div class="post-top-comments">
                    <div class="post-top-comments-title">Top comments</div>
                    <button class="btn comment-toggle" data-subreddit="${post.subreddit}" data-post-id="${post.id}" data-limit="${commentsLimit}">Load comments</button>
                    <div class="comment-list" data-show-author="false" hidden></div>
                </div>
            </article>
        `;
    }
    
    // Initialize video controls for newly added posts
    function initVideoControls(container) {
        // Trigger DOMContentLoaded-like initialization for new videos
        const event = new CustomEvent('newPostsAdded', { detail: { container } });
        document.dispatchEvent(event);
    }
    
    async function loadMorePosts() {
        if (loading || noMorePosts || !after) return;
        
        loading = true;
        loadingIndicator.style.display = 'block';
        
        try {
            const response = await fetch(`/api/posts?subreddit=${encodeURIComponent(subreddit)}&sort=${encodeURIComponent(sort)}&t=${encodeURIComponent(timeFilter)}&after=${encodeURIComponent(after)}`);
            const data = await response.json();
            
            if (data.posts && data.posts.length > 0) {
                data.posts.forEach(post => {
                    postCount++;
                    const postHTML = createPostHTML(post, postCount);
                    container.insertAdjacentHTML('beforeend', postHTML);
                    
                    // Add to mini-nav
                    addToMiniNav(post, postCount);
                });
                
                after = data.after;
                container.dataset.after = after || '';
                
                if (!after) {
                    noMorePosts = true;
                    noMoreIndicator.style.display = 'block';
                }
                
                // Re-initialize video controls for new posts
                initVideoControls(container);
                setupTriggerObserver();
            } else {
                noMorePosts = true;
                noMoreIndicator.style.display = 'block';
            }
        } catch (err) {
            console.error('Error loading more posts:', err);
        } finally {
            loading = false;
            loadingIndicator.style.display = 'none';
        }
    }
    
    // Observer for triggering load at post 20 (or 5 posts before end)
    function setupTriggerObserver() {
        const posts = document.querySelectorAll('.post');
        const triggerIndex = Math.max(posts.length - 5, 20);
        const triggerPost = posts[triggerIndex - 1];
        
        if (!triggerPost || triggerPost.dataset.observed) return;
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    loadMorePosts();
                    observer.disconnect();
                }
            });
        }, { threshold: 0.1 });
        
        triggerPost.dataset.observed = 'true';
        observer.observe(triggerPost);
    }
    
    // Add post to mini-nav
    function addToMiniNav(post, index) {
        const miniNavItems = document.getElementById('mini-nav-items');
        if (!miniNavItems) return;
        
        const thumbnail = post.thumbnail || post.image_url || '';
        const isValidThumb = thumbnail && thumbnail.startsWith('http');
        
        let content;
        if (isValidThumb) {
            content = `<img src="${thumbnail}" alt="" class="mini-nav-thumb">`;
        } else if (post.is_self) {
            content = `<div class="mini-nav-placeholder">ğŸ“</div>`;
        } else {
            content = `<div class="mini-nav-placeholder">ğŸ”—</div>`;
        }
        
        const item = document.createElement('a');
        item.href = `#post-${index}`;
        item.className = 'mini-nav-item';
        item.dataset.postIndex = index;
        item.title = post.title;
        item.innerHTML = content;
        miniNavItems.appendChild(item);
    }
    
    // Initial setup
    if (after) {
        setupTriggerObserver();
    }
    
    // Mini-nav click handler - smooth scroll
    const miniNav = document.getElementById('mini-nav');
    const miniNavItems = document.getElementById('mini-nav-items');
    if (miniNav && miniNavItems) {
        miniNav.addEventListener('click', (e) => {
            const item = e.target.closest('.mini-nav-item');
            if (item) {
                e.preventDefault();
                const postId = item.getAttribute('href').substring(1);
                const post = document.getElementById(postId);
                if (post) {
                    post.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });
        
        // Sync mini-nav scroll with page scroll - smooth active-based scrolling
        let ticking = false;
        let targetScrollTop = 0;
        let currentScrollTop = 0;
        
        function syncMiniNavScroll() {
            const posts = document.querySelectorAll('.post');
            if (posts.length === 0) return;
            
            // Find closest post to viewport center for active highlighting
            const viewportCenter = window.innerHeight / 2;
            let closestPost = null;
            let closestDistance = Infinity;
            
            posts.forEach(post => {
                const rect = post.getBoundingClientRect();
                const postCenter = rect.top + rect.height / 2;
                const distance = Math.abs(postCenter - viewportCenter);
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestPost = post;
                }
            });
            
            if (closestPost) {
                const index = closestPost.dataset.postIndex;
                const navItem = miniNav.querySelector(`[data-post-index="${index}"]`);
                if (navItem) {
                    miniNav.querySelectorAll('.mini-nav-item').forEach(i => i.classList.remove('active'));
                    navItem.classList.add('active');
                    
                    // Calculate target scroll to center the active item
                    const navItemCenter = navItem.offsetTop + navItem.offsetHeight / 2;
                    const containerCenter = miniNavItems.clientHeight / 2;
                    targetScrollTop = Math.max(0, navItemCenter - containerCenter);
                }
            }
            
            // Smooth interpolation toward target
            const diff = targetScrollTop - currentScrollTop;
            if (Math.abs(diff) > 0.5) {
                currentScrollTop += diff * 0.15;
                miniNavItems.scrollTop = currentScrollTop;
                requestAnimationFrame(syncMiniNavScroll);
            } else {
                currentScrollTop = targetScrollTop;
                miniNavItems.scrollTop = currentScrollTop;
                ticking = false;
            }
        }
        
        window.addEventListener('scroll', () => {
            if (!ticking) {
                ticking = true;
                requestAnimationFrame(syncMiniNavScroll);
            }
        });
        
        // Adjust sidebar position based on header visibility
        function updateNavPosition() {
            const header = document.querySelector('.header');
            if (header) {
                const isHidden = header.classList.contains('header-hidden');
                miniNav.style.setProperty('--nav-top', isHidden ? '20px' : '70px');
            }
        }
        
        // Watch for header class changes
        const header = document.querySelector('.header');
        if (header) {
            const observer = new MutationObserver(updateNavPosition);
            observer.observe(header, { attributes: true, attributeFilter: ['class'] });
            updateNavPosition();
        }
        
        // Initial sync
        currentScrollTop = miniNavItems.scrollTop;
        syncMiniNavScroll();
    }
})();
</script>
{% endblock %}
