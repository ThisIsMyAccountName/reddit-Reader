{% extends "base.html" %}

{% block title %}r/{{ subreddit }} - Reddit Reader{% endblock %}

{% block content %}
<!-- Mini navigation sidebar -->
<div class="mini-nav {% if sidebar_position == 'right' %}mini-nav-right{% elif sidebar_position == 'off' %}mini-nav-hidden{% endif %}" id="mini-nav">
    <div class="mini-nav-title">Posts</div>
    <div class="mini-nav-viewport" id="mini-nav-viewport"></div>
    <div class="mini-nav-items" id="mini-nav-items">
        {% for post in posts %}
        <a href="#post-{{ loop.index }}" class="mini-nav-item" data-post-index="{{ loop.index }}" title="{{ post.title }}">
            {% if post.thumbnail and post.thumbnail.startswith('http') %}
            <img src="{{ post.thumbnail }}" alt="" class="mini-nav-thumb">
            {% elif post.image_url %}
            <img src="{{ post.image_url }}" alt="" class="mini-nav-thumb">
            {% elif post.is_self %}
            <div class="mini-nav-placeholder">üìù</div>
            {% else %}
            <div class="mini-nav-placeholder">üîó</div>
            {% endif %}
        </a>
        {% endfor %}
    </div>
</div>

<div class="main-content">
<div class="subreddit-nav">
    {% if current_user.is_authenticated and pinned_subs %}
        {% for sub in pinned_subs %}
        <a href="{{ url_for('subreddit', name=sub) }}" class="subreddit-link {% if sub == subreddit %}active{% endif %}">r/{{ sub }}</a>
        {% endfor %}
        {% if subreddit not in pinned_subs %}
        <span class="subreddit-link active">r/{{ subreddit }}</span>
        {% endif %}
    {% else %}
        <a href="{{ url_for('subreddit', name='all') }}" class="subreddit-link {% if subreddit == 'all' %}active{% endif %}">r/all</a>
        <a href="{{ url_for('subreddit', name='popular') }}" class="subreddit-link {% if subreddit == 'popular' %}active{% endif %}">r/popular</a>
        {% if subreddit not in ['all', 'popular'] %}
        <span class="subreddit-link active">r/{{ subreddit }}</span>
        {% endif %}
    {% endif %}
</div>

<div class="controls">
    <span class="text-secondary">Sort by:</span>
    <a href="{{ url_for('subreddit', name=subreddit, sort='hot') }}" 
       class="sort-link {% if sort == 'hot' %}active{% endif %}">üî• Hot</a>
    <a href="{{ url_for('subreddit', name=subreddit, sort='new') }}" 
       class="sort-link {% if sort == 'new' %}active{% endif %}">üÜï New</a>
    <a href="{{ url_for('subreddit', name=subreddit, sort='top', t=time_filter or 'day') }}" 
       class="sort-link {% if sort == 'top' %}active{% endif %}">‚≠ê Top</a>
    <a href="{{ url_for('subreddit', name=subreddit, sort='rising') }}" 
       class="sort-link {% if sort == 'rising' %}active{% endif %}">üìà Rising</a>
    
    {% if sort == 'top' %}
    <span class="time-filter-divider">|</span>
    <select id="time-filter" class="time-filter-select" onchange="window.location.href=this.value">
        <option value="{{ url_for('subreddit', name=subreddit, sort='top', t='hour') }}" {% if time_filter == 'hour' %}selected{% endif %}>Past Hour</option>
        <option value="{{ url_for('subreddit', name=subreddit, sort='top', t='day') }}" {% if time_filter == 'day' %}selected{% endif %}>Today</option>
        <option value="{{ url_for('subreddit', name=subreddit, sort='top', t='week') }}" {% if time_filter == 'week' %}selected{% endif %}>This Week</option>
        <option value="{{ url_for('subreddit', name=subreddit, sort='top', t='month') }}" {% if time_filter == 'month' %}selected{% endif %}>This Month</option>
        <option value="{{ url_for('subreddit', name=subreddit, sort='top', t='year') }}" {% if time_filter == 'year' %}selected{% endif %}>This Year</option>
        <option value="{{ url_for('subreddit', name=subreddit, sort='top', t='all') }}" {% if time_filter == 'all' %}selected{% endif %}>All Time</option>
    </select>
    {% endif %}
</div>

<div id="posts-container" 
     data-subreddit="{{ subreddit }}" 
     data-sort="{{ sort }}" 
     data-time-filter="{{ time_filter or 'day' }}"
     data-after="{{ after or '' }}"
     data-comments-limit="{{ comments_limit }}">
{% if posts %}
    {% for post in posts %}
    <article class="post" id="post-{{ loop.index }}" 
             data-post-index="{{ loop.index }}" 
             data-thumbnail="{{ post.thumbnail or post.image_url or '' }}"
             data-subreddit="{{ post.subreddit }}"
             data-post-id="{{ post.id }}"
             data-current-limit="0"
             data-increment="3"
             style="cursor: pointer;">
        <h2 class="post-title">
            <a href="{{ url_for('comments', subreddit=post.subreddit, post_id=post.id) }}">
                {{ post.title }}
            </a>
            <div class="post-meta">
                <span class="post-meta-item">r/{{ post.subreddit }}</span>
                <span class="post-meta-actions">
                    {% if not post.is_self %}
                    <a href="{{ post.url }}" target="_blank" class="meta-action-btn" title="Open link">üîó</a>
                    {% endif %}
                    <a href="{{ post.permalink }}" target="_blank" class="meta-action-btn" title="View on Reddit">üì§</a>
                    {% if current_user.is_authenticated and post.subreddit != subreddit %}
                    <form method="post" action="{{ url_for('ban_subreddit', subreddit=post.subreddit) }}" class="inline-form" onsubmit="return confirm('Ban r/{{ post.subreddit }}? Posts from this subreddit will be hidden.')">
                        <button type="submit" class="meta-action-btn ban-btn" title="Ban r/{{ post.subreddit }}">üö´</button>
                    </form>
                    {% endif %}
                </span>
            </div>
        </h2>
        
        {% if post.is_self and post.selftext %}
        <div class="post-selftext">
            {% if not post.thumbnail and not post.image_url %}
                {{ post.selftext | format_content | safe }}
            {% else %}
                {{ post.selftext[:300] | format_content | safe }}{% if post.selftext|length > 300 %}...{% endif %}
            {% endif %}
        </div>
        {% endif %}

        {% if post.is_video and (post.hls_url or post.video_url) %}
        <div class="post-media video-container" data-hls-url="{{ post.hls_url }}" data-audio-url="{{ post.audio_url }}">
            <video class="post-video" src="{{ post.video_url }}" loop playsinline autoplay muted></video>
            {% if post.audio_url %}
            <audio class="video-audio" src="{{ post.audio_url }}" style="display:none;" loop muted></audio>
            {% endif %}
            <button class="media-download-btn" data-url="{{ post.video_url }}" data-type="video" title="Download" aria-label="Download">
                ‚§ì
            </button>
            <div class="video-controls">
                <button class="video-btn video-play-pause" aria-label="Play/Pause">‚è∏</button>
                <div class="video-timeline">
                    <div class="video-progress"></div>
                </div>
                <div class="video-volume-container">
                    <button class="video-btn video-mute" aria-label="Mute">üîá</button>
                    <input type="range" class="video-volume-slider" min="0" max="100" value="0">
                </div>
                <div class="video-speed-container">
                    <select class="video-speed-select" aria-label="Playback speed">
                        <option value="0.25">0.25x</option>
                        <option value="0.5">0.5x</option>
                        <option value="0.75">0.75x</option>
                        <option value="1" selected>1x</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                        <option value="1.75">1.75x</option>
                        <option value="2">2x</option>
                    </select>
                </div>
                <button class="video-btn video-fullscreen" aria-label="Fullscreen">‚õ∂</button>
            </div>
        </div>
        {% elif post.gallery_urls and post.gallery_urls|length > 0 %}
        <div class="post-media gallery">
            <div class="gallery-scroll">
                {% for url in post.gallery_urls %}
                <div class="gallery-item">
                    <img class="gallery-image" src="{{ url }}" alt="Gallery image" loading="lazy">
                    <button class="media-download-btn" data-url="{{ url }}" data-type="image" title="Download" aria-label="Download">
                        ‚§ì
                    </button>
                </div>
                {% endfor %}
            </div>
            {% if post.gallery_urls|length > 1 %}
            <button class="gallery-nav gallery-nav-left" aria-label="Previous image">‚Äπ</button>
            <button class="gallery-nav gallery-nav-right" aria-label="Next image">‚Ä∫</button>
            {% endif %}
        </div>
        {% elif post.image_url %}
        <div class="post-media">
            <img class="post-image" src="{{ post.image_url }}" alt="Post image">
            <button class="media-download-btn" data-url="{{ post.image_url }}" data-type="image" title="Download" aria-label="Download">
                ‚§ì
            </button>
        </div>
        {% endif %}
        


        <div class="post-top-comments">
            <div class="comment-list" data-show-author="false" hidden></div>
        </div>
    </article>
    {% endfor %}
</div>

<div id="loading-indicator" style="display: none; text-align: center; padding: 20px;">
    <span class="text-secondary">Loading more posts...</span>
</div>

<div id="no-more-posts" style="display: none; text-align: center; padding: 20px;">
    <span class="text-secondary">No more posts to load</span>
</div>
</div><!-- close main-content -->

{% else %}
    <div class="error-container">
        <div class="error-title">üòï</div>
        <p class="error-message">No posts found for r/{{ subreddit }}</p>
        <a href="{{ url_for('index') }}" class="btn btn-primary">Go to r/all</a>
    </div>
</div>
</div>
{% endif %}

<script>
(function() {
    const container = document.getElementById('posts-container');
    if (!container) return;
    
    const subreddit = container.dataset.subreddit;
    const sort = container.dataset.sort;
    const timeFilter = container.dataset.timeFilter || 'day';
    const commentsLimit = container.dataset.commentsLimit;
    let after = container.dataset.after;
    let loading = false;
    let noMorePosts = false;
    let postCount = document.querySelectorAll('.post').length;
    
    const loadingIndicator = document.getElementById('loading-indicator');
    const noMoreIndicator = document.getElementById('no-more-posts');
    
    // Create post HTML from post data
    function createPostHTML(post, index) {
        const selftext = post.selftext ? post.selftext.substring(0, 300) + (post.selftext.length > 300 ? '...' : '') : '';
        const score = post.score.toLocaleString();
        const numComments = post.num_comments.toLocaleString();
        
        let mediaHTML = '';
        
        if (post.is_video && (post.hls_url || post.video_url)) {
            mediaHTML = `
                <div class="post-media video-container" data-hls-url="${post.hls_url || ''}" data-audio-url="${post.audio_url || ''}">
                    <video class="post-video" src="${post.video_url}" loop playsinline autoplay muted></video>
                    ${post.audio_url ? `<audio class="video-audio" src="${post.audio_url}" style="display:none;" loop muted></audio>` : ''}
                    <button class="media-download-btn" data-url="${post.video_url}" data-type="video" title="Download" aria-label="Download">‚§ì</button>
                    <div class="video-controls">
                        <button class="video-btn video-play-pause" aria-label="Play/Pause">‚è∏</button>
                        <div class="video-timeline"><div class="video-progress"></div></div>
                        <div class="video-volume-container">
                            <button class="video-btn video-mute" aria-label="Mute">üîá</button>
                            <input type="range" class="video-volume-slider" min="0" max="100" value="0">
                        </div>
                        <div class="video-speed-container">
                            <select class="video-speed-select" aria-label="Playback speed">
                                <option value="0.25">0.25x</option>
                                <option value="0.5">0.5x</option>
                                <option value="0.75">0.75x</option>
                                <option value="1" selected>1x</option>
                                <option value="1.25">1.25x</option>
                                <option value="1.5">1.5x</option>
                                <option value="1.75">1.75x</option>
                                <option value="2">2x</option>
                            </select>
                        </div>
                        <button class="video-btn video-fullscreen" aria-label="Fullscreen">‚õ∂</button>
                    </div>
                </div>`;
        } else if (post.gallery_urls && post.gallery_urls.length > 0) {
            const galleryItems = post.gallery_urls.map(url => `
                <div class="gallery-item">
                    <img class="gallery-image" src="${url}" alt="Gallery image" loading="lazy">
                    <button class="media-download-btn" data-url="${url}" data-type="image" title="Download" aria-label="Download">‚§ì</button>
                </div>
            `).join('');
            mediaHTML = `
                <div class="post-media gallery">
                    <div class="gallery-scroll">${galleryItems}</div>
                    ${post.gallery_urls.length > 1 ? `
                        <button class="gallery-nav gallery-nav-left" aria-label="Previous image">‚Äπ</button>
                        <button class="gallery-nav gallery-nav-right" aria-label="Next image">‚Ä∫</button>
                    ` : ''}
                </div>`;
        } else if (post.image_url) {
            mediaHTML = `
                <div class="post-media">
                    <img class="post-image" src="${post.image_url}" alt="Post image">
                    <button class="media-download-btn" data-url="${post.image_url}" data-type="image" title="Download" aria-label="Download">‚§ì</button>
                </div>`;
        }
        
        const thumbnail = post.thumbnail || post.image_url || '';
        
        return `
            <article class="post" id="post-${index}" data-post-index="${index}" data-thumbnail="${thumbnail}">
                <h2 class="post-title">
                    <a href="/r/${post.subreddit}/comments/${post.id}">${post.title}</a>
                </h2>
                <div class="post-meta">
                    <span class="post-meta-item">üë§ u/${post.author}</span>
                    <span class="post-meta-item">üìç r/${post.subreddit}</span>
                    <span class="post-meta-item">‚¨ÜÔ∏è ${score}</span>
                    <span class="post-meta-item">üí¨ ${numComments}</span>
                    <span class="post-meta-actions">
                        ${!post.is_self ? `<a href="${post.url}" target="_blank" class="meta-action-btn" title="Open link">üîó</a>` : ''}
                        <a href="${post.permalink}" target="_blank" class="meta-action-btn" title="View on Reddit">üì§</a>
                    </span>
                </div>
                ${post.is_self && selftext ? `<div class="post-selftext">${selftext}</div>` : ''}
                ${mediaHTML}
                <div class="post-top-comments">
                    <div class="post-top-comments-title"></div>
                    <button class="btn comment-toggle" data-subreddit="${post.subreddit}" data-post-id="${post.id}" data-limit="${commentsLimit}">Load comments</button>
                    <div class="comment-list" data-show-author="false" hidden></div>
                </div>
            </article>
        `;
    }
    
    // Initialize video controls for newly added posts
    function initVideoControls(container) {
        // Trigger DOMContentLoaded-like initialization for new videos
        const event = new CustomEvent('newPostsAdded', { detail: { container } });
        document.dispatchEvent(event);
    }
    
    async function loadMorePosts() {
        if (loading || noMorePosts || !after) return;
        
        loading = true;
        loadingIndicator.style.display = 'block';
        
        try {
            const response = await fetch(`/api/posts?subreddit=${encodeURIComponent(subreddit)}&sort=${encodeURIComponent(sort)}&t=${encodeURIComponent(timeFilter)}&after=${encodeURIComponent(after)}`);
            const data = await response.json();
            
            if (data.posts && data.posts.length > 0) {
                data.posts.forEach(post => {
                    postCount++;
                    const postHTML = createPostHTML(post, postCount);
                    container.insertAdjacentHTML('beforeend', postHTML);
                    
                    // Add to mini-nav
                    addToMiniNav(post, postCount);
                });
                
                after = data.after;
                container.dataset.after = after || '';
                
                if (!after) {
                    noMorePosts = true;
                    noMoreIndicator.style.display = 'block';
                }
                
                // Re-initialize video controls for new posts
                initVideoControls(container);
                setupTriggerObserver();
            } else {
                noMorePosts = true;
                noMoreIndicator.style.display = 'block';
            }
        } catch (err) {
            console.error('Error loading more posts:', err);
        } finally {
            loading = false;
            loadingIndicator.style.display = 'none';
        }
    }
    
    // Observer for triggering load at post 20 (or 5 posts before end)
    function setupTriggerObserver() {
        const posts = document.querySelectorAll('.post');
        const triggerIndex = Math.max(posts.length - 5, 20);
        const triggerPost = posts[triggerIndex - 1];
        
        if (!triggerPost || triggerPost.dataset.observed) return;
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    loadMorePosts();
                    observer.disconnect();
                }
            });
        }, { threshold: 0.1 });
        
        triggerPost.dataset.observed = 'true';
        observer.observe(triggerPost);
    }
    
    // Add post to mini-nav
    function addToMiniNav(post, index) {
        const miniNavItems = document.getElementById('mini-nav-items');
        if (!miniNavItems) return;
        
        const thumbnail = post.thumbnail || post.image_url || '';
        const isValidThumb = thumbnail && thumbnail.startsWith('http');
        
        let content;
        if (isValidThumb) {
            content = `<img src="${thumbnail}" alt="" class="mini-nav-thumb">`;
        } else if (post.is_self) {
            content = `<div class="mini-nav-placeholder">üìù</div>`;
        } else {
            content = `<div class="mini-nav-placeholder">üîó</div>`;
        }
        
        const item = document.createElement('a');
        item.href = `#post-${index}`;
        item.className = 'mini-nav-item';
        item.dataset.postIndex = index;
        item.title = post.title;
        item.innerHTML = content;
        miniNavItems.appendChild(item);
    }
    
    // Initial setup
    if (after) {
        setupTriggerObserver();
    }
    
    // Mini-nav minimap functionality (like VS Code)
    const miniNav = document.getElementById('mini-nav');
    const miniNavItems = document.getElementById('mini-nav-items');
    const miniNavViewport = document.getElementById('mini-nav-viewport');
    
    if (miniNav && miniNavItems && miniNavViewport) {
        let isDraggingViewport = false;
        let dragStartY = 0;
        let dragStartScroll = 0;
        
        // Update viewport indicator position and size
        function updateViewportIndicator() {
            const maxPageScroll = document.documentElement.scrollHeight - window.innerHeight;
            const currentPageScroll = window.pageYOffset || document.documentElement.scrollTop;
            const scrollRatio = maxPageScroll > 0 ? currentPageScroll / maxPageScroll : 0;
            
            // Sync mini-nav items scroll
            const maxNavScroll = miniNavItems.scrollHeight - miniNavItems.clientHeight;
            miniNavItems.scrollTop = scrollRatio * maxNavScroll;
            
            // Calculate viewport indicator size and position
            const viewportHeight = window.innerHeight;
            const totalHeight = document.documentElement.scrollHeight;
            const miniNavHeight = miniNav.clientHeight;
            
            const viewportRatio = viewportHeight / totalHeight;
            const indicatorHeight = Math.max(30, miniNavHeight * viewportRatio);
            const indicatorTop = scrollRatio * (miniNavHeight - indicatorHeight);
            
            miniNavViewport.style.height = indicatorHeight + 'px';
            miniNavViewport.style.top = indicatorTop + 'px';
            
            // Update active post highlighting
            const posts = document.querySelectorAll('.post');
            const viewportCenter = window.innerHeight / 2;
            let closestPost = null;
            let closestDistance = Infinity;
            
            posts.forEach(post => {
                const rect = post.getBoundingClientRect();
                const postCenter = rect.top + rect.height / 2;
                const distance = Math.abs(postCenter - viewportCenter);
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestPost = post;
                }
            });
            
            if (closestPost) {
                const index = closestPost.dataset.postIndex;
                const navItem = miniNav.querySelector(`[data-post-index="${index}"]`);
                if (navItem) {
                    miniNav.querySelectorAll('.mini-nav-item').forEach(i => i.classList.remove('active'));
                    navItem.classList.add('active');
                }
            }
        }
        
        // Click on minimap to jump to position
        miniNav.addEventListener('mousedown', (e) => {
            if (e.target === miniNavViewport || miniNavViewport.contains(e.target)) {
                // Start dragging viewport
                isDraggingViewport = true;
                dragStartY = e.clientY;
                dragStartScroll = window.pageYOffset || document.documentElement.scrollTop;
                e.preventDefault();
            } else if (e.target === miniNav || e.target === miniNavItems || miniNavItems.contains(e.target)) {
                // Click to jump
                const rect = miniNav.getBoundingClientRect();
                const clickRatio = (e.clientY - rect.top) / rect.height;
                const maxPageScroll = document.documentElement.scrollHeight - window.innerHeight;
                const targetScroll = clickRatio * maxPageScroll;
                window.scrollTo(0, targetScroll);
                e.preventDefault();
            }
        });
        
        // Drag viewport to scroll
        document.addEventListener('mousemove', (e) => {
            if (isDraggingViewport) {
                const deltaY = e.clientY - dragStartY;
                const miniNavHeight = miniNav.clientHeight;
                const maxPageScroll = document.documentElement.scrollHeight - window.innerHeight;
                const scrollDelta = (deltaY / miniNavHeight) * maxPageScroll;
                window.scrollTo(0, dragStartScroll + scrollDelta);
                e.preventDefault();
            }
        });
        
        document.addEventListener('mouseup', () => {
            isDraggingViewport = false;
        });
        
        window.addEventListener('scroll', updateViewportIndicator, { passive: true });
        window.addEventListener('resize', updateViewportIndicator, { passive: true });
        
        // Adjust sidebar position based on header visibility
        function updateNavPosition() {
            const header = document.querySelector('.header');
            if (header) {
                const isHidden = header.classList.contains('header-hidden');
                miniNav.style.setProperty('--nav-top', isHidden ? '20px' : '70px');
                // Update viewport indicator when header position changes
                setTimeout(updateViewportIndicator, 350);
            }
        }
        
        // Watch for header class changes
        const header = document.querySelector('.header');
        if (header) {
            const observer = new MutationObserver(updateNavPosition);
            observer.observe(header, { attributes: true, attributeFilter: ['class'] });
            updateNavPosition();
        }
        
        // Initial update
        updateViewportIndicator();
    }
})();
</script>
{% endblock %}
