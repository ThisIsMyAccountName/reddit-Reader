{% extends "base.html" %}

{% block title %}Settings - Reddit Reader{% endblock %}

{% block content %}
<div class="settings-container">
    <h1>‚öôÔ∏è Settings</h1>
    
    <!-- subreddit-related preferences grouped together -->
    <div class="settings-section">
        <h2>Subreddit Preferences</h2>

        <h3>üìå Pinned Subreddits</h3>
        
        <form method="post" class="add-sub-form">
            {{ add_form.hidden_tag() }}
            {{ add_form.sub(class_="form-input", placeholder="Enter subreddit name (e.g., python)", autocomplete="off") }}
            <button type="submit" class="btn btn-primary">Add</button>
        </form>
        <p class="form-help">Drag to reorder</p>
        
        {% if pinned_subs %}
        <form method="post" id="reorder-form">
            {{ reorder_form.csrf_token }}
            {{ reorder_form.intent }}
            {{ reorder_form.order(id="pinned-order", value=(pinned_subs | join(','))) }}
        </form>
        <div class="pinned-list" id="pinned-list">
            {% for sub in pinned_subs %}
            <div class="pinned-item" data-sub="{{ sub }}">
                <!-- only the handle is draggable to avoid interfering with clicks on links/buttons -->
                <span class="drag-handle" draggable="true">‚ãÆ‚ãÆ</span>
                <a href="{{ url_for('subreddit', name=sub) }}" class="pinned-item-name" draggable="false">r/{{ sub }}</a>
                <form method="post" class="pinned-item-remove" draggable="false">
                    {{ remove_form.csrf_token }}
                    {{ remove_form.intent }}
                    {{ remove_form.sub(value=sub) }}
                    <button type="submit" class="btn btn-small btn-danger" title="Remove" draggable="false">‚úï</button>
                </form>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-secondary" style="margin-top: 15px;">No pinned subreddits yet. Add some above!</p>
        {% endif %}
        
        <h3>üö´ Banned Subreddits</h3>
        <p class="form-help">Posts from these subreddits are hidden from feeds like r/all.</p>
        
        {% if banned_subs %}
        <div class="banned-list">
            {% for sub in banned_subs %}
            <div class="banned-item">
                <span class="banned-item-name">r/{{ sub }}</span>
                <form method="post" class="banned-item-remove">
                        {{ unban_form.csrf_token }}
                        {{ unban_form.intent }}
                    {{ unban_form.sub(value=sub) }}
                    <button type="submit" class="btn btn-small btn-success" title="Unban">Unban</button>
                </form>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-secondary" style="margin-top: 15px;">No banned subreddits. Use the üö´ button on posts to ban.</p>
        {% endif %}
    </div>
    
    <div class="settings-section">
        <h2>Display & Playback</h2>
        <p class="form-help">Changes are saved immediately when you adjust controls.</p>

        <div class="setting-row">
            <label>Sidebar Position</label>
            <div class="radio-group">
                {% for subfield in sidebar_form.sidebar_position %}
                <label class="radio-label">
                    {{ subfield(class_="ajax-setting", data_field="sidebar_position") }}
                    {{ subfield.label }}
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="setting-row">
            <label for="default_volume">Default Volume</label>
            <div class="range-input-group">
                <input type="range" id="default_volume" class="range-input ajax-setting" data-field="default_volume" min="0" max="100" value="{{ playback_form.default_volume.data or default_volume }}">
                <span class="range-value" id="volume-value">{{ playback_form.default_volume.data or default_volume }}%</span>
            </div>
        </div>

        <div class="setting-row">
            <label for="default_speed">Default Speed</label>
            <div class="range-input-group">
                <input type="range" id="default_speed" class="range-input ajax-setting" data-field="default_speed" min="0.25" max="2.0" step="0.25" value="{{ playback_form.default_speed.data or default_speed }}">
                <span class="range-value" id="speed-value">{{ playback_form.default_speed.data or default_speed }}x</span>
            </div>
        </div>

        <div class="setting-row">
            <label>
                {{ behavior_form.title_links(class_="ajax-setting", data_field="title_links") }}
                Make post titles clickable (open comments when clicked)
            </label>
        </div>
    </div>
    
    <div class="settings-section">
        <h2>Quick Add</h2>
        <p class="form-help">Click to add popular subreddits:</p>
        <div class="quick-add-subs">
            {% for sub in ['all', 'popular', 'news', 'gaming', 'pics', 'videos', 'funny', 'askreddit', 'worldnews', 'technology', 'science', 'programming'] %}
            <form method="post" style="display: inline;">
                {{ add_form.hidden_tag() }}
                {{ add_form.sub(type="hidden", value=sub) }}
                <button type="submit" class="btn btn-small {% if sub in pinned_subs %}btn-disabled{% endif %}" {% if sub in pinned_subs %}disabled{% endif %}>{{ sub }}</button>
            </form>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    // Scroll to top on page load (after reorder redirect)
    window.scrollTo(0, 0);
    
    // Volume slider preview
    const volumeSlider = document.getElementById('default_volume');
    const volumeValue = document.getElementById('volume-value');
    if (volumeSlider && volumeValue) {
        volumeSlider.addEventListener('input', () => {
            volumeValue.textContent = volumeSlider.value + '%';
        });

        // allow clicking percentage text to edit directly
        volumeValue.addEventListener('click', () => {
            const current = parseInt(volumeSlider.value, 10);
            const input = document.createElement('input');
            input.type = 'number';
            input.min = 0;
            input.max = 100;
            input.value = current;
            input.style.width = '50px';
            volumeValue.replaceWith(input);
            input.focus();

            const commit = () => {
                let val = parseInt(input.value, 10);
                if (isNaN(val)) val = current;
                val = Math.max(0, Math.min(100, val));
                volumeSlider.value = val;
                sendSetting('default_volume', val);
                volumeValue.textContent = val + '%';
                input.replaceWith(volumeValue);
            };
            input.addEventListener('blur', commit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    commit();
                } else if (e.key === 'Escape') {
                    input.replaceWith(volumeValue);
                }
            });
        });
    }
    const speedSlider = document.getElementById('default_speed');
    const speedValue = document.getElementById('speed-value');
    if (speedSlider && speedValue) {
        speedSlider.addEventListener('input', () => {
            speedValue.textContent = speedSlider.value + 'x';
        });
    }
    
    // Drag and drop reordering
    const pinnedList = document.getElementById('pinned-list');
    const orderInput = document.getElementById('pinned-order');
    const reorderForm = document.getElementById('reorder-form');
    
    if (pinnedList) {
        let draggedItem = null;
        
        pinnedList.addEventListener('dragstart', (e) => {
            // only start a drag from the handle; ignore other clicks
            const handle = e.target.closest('.drag-handle');
            if (!handle) {
                e.preventDefault();
                return;
            }

            const item = e.target.closest('.pinned-item');
            if (item) {
                draggedItem = item;
                item.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                // Firefox requires data to be set for drag to work
                try {
                    e.dataTransfer.setData('text/plain', '');
                } catch (err) {
                    // ignore if not supported
                }
            }
        });
        
        pinnedList.addEventListener('dragend', (e) => {
            const item = e.target.closest('.pinned-item');
            if (item) {
                item.classList.remove('dragging');
                draggedItem = null;
                updateOrder();
            }
        });
        
        pinnedList.addEventListener('dragover', (e) => {
            e.preventDefault();
            const afterElement = getDragAfterElement(pinnedList, e.clientY);
            if (draggedItem) {
                if (afterElement) {
                    pinnedList.insertBefore(draggedItem, afterElement);
                } else {
                    pinnedList.appendChild(draggedItem);
                }
            }
        });
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.pinned-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        function updateOrder() {
            const items = pinnedList.querySelectorAll('.pinned-item');
            const order = [...items].map(item => item.dataset.sub).join(',');
            orderInput.value = order;
            
            // Update visible badges
            items.forEach((item, index) => {
                const badge = item.querySelector('.pinned-badge');
                if (index < 5) {
                    if (!badge) {
                        const newBadge = document.createElement('span');
                        newBadge.className = 'pinned-badge';
                        newBadge.textContent = 'visible';
                        item.querySelector('.pinned-item-name').after(newBadge);
                    }
                } else if (badge) {
                    badge.remove();
                }
            });
            
            // Auto-save the new order
            reorderForm.submit();
        }
    }
</script>

<script>
    // AJAX helper to post single-field updates
    function sendSetting(field, value) {
        fetch('/settings/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.csrfToken,
            },
            body: JSON.stringify({ field, value }),
        })
            .then((r) => r.json())
            .then((data) => {
                if (!data.success) {
                    console.warn('setting update failed', data);
                }
            })
            .catch((err) => console.error('error sending setting', err));
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.ajax-setting').forEach((el) => {
            el.addEventListener('change', () => {
                let v;
                if (el.type === 'checkbox') {
                    v = el.checked;
                } else {
                    v = el.value;
                }
                const field = el.getAttribute('data-field');
                if (field) {
                    sendSetting(field, v);
                }
            });
        });
    });
</script>
{% endblock %}
